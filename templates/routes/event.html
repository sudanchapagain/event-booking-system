<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= htmlspecialchars($event['title'] ?? 'Event Details') ?> - Chautari</title>
    <link rel="stylesheet" href="../assets/css/default.css">
    <link rel="stylesheet" href="../assets/css/index.css">
    <link rel="stylesheet" href="../assets/css/event.css">
</head>

<body>
    <?php include __DIR__ . '/../components/header.php'; ?>

    <main>
        <?php if (isset($error)): ?>
            <div class="error-message"><?= htmlspecialchars($error) ?></div>
        <?php else: ?>
            <div class="event-details boxed-text">
                <?php if ($image && isset($image['image_url'])): ?>
                    <img src="<?= htmlspecialchars($image['image_url']); ?>" width="100%" style="height: 400px; border-radius: 12px;border: 1px solid black; margin-top: 5rem;">
                <?php else: ?>
                    <div style="display: block; height: 100px"></div>
                <?php endif; ?>

                <h2 style="text-align: left;font-size: 3rem;"><?= htmlspecialchars($event['title']) ?></h2>
                <br>
                <div class="event-meta" style="display: grid;grid-template-columns: 1fr 1fr 1fr;">
                    <p><b>Organizer:</b> <?= htmlspecialchars($event['organizer_name'] ?? 'Unknown') ?></p>
                    <p><b>Address:</b> <?= htmlspecialchars($event['location']) ?></p>
                    <p><b>Available Capacity: </b><?= $event['capacity'] - $event['current_participants'] ?></p>
                </div>

                <br><br>
                <p style="font-size: 1.3rem; text-align: center;"><?= htmlspecialchars($event['ticket_price']) ?> <b><small>NPR</small></b></p>

                <div class="event-actions" style="margin: 50px auto; max-width: 400px; display: flex; gap: 10px;">
                    <?php if ($is_booked): ?>
                        <form action="/event?event_id=<?= $event_id ?>" method="GET" style="margin: 0;">
                            <input type="hidden" name="event_id" value="<?= $event_id ?>">
                            <input type="hidden" name="action" value="cancel">
                            <button type="submit" class="secondary-button" style="background-color: #E81C30; border:none; color: #fff;">Cancel Booking</button>
                        </form>
                    <?php elseif (!isset($_SESSION['user_id'])): ?>
                        <p><a href="/login" class="secondary-button">Login to register for this event</a></p>
                    <?php else: ?>
                        <?php if ($event['ticket_price'] == 0): ?>
                            <form action="/event?event_id=<?= $event_id ?>" method="GET" style="margin: 0;">
                                <input type="hidden" name="event_id" value="<?= $event_id ?>">
                                <input type="hidden" name="action" value="register">
                                <button type="submit" class="primary-button register-btn" style="border: none;">Book Event</button>
                            </form>
                        <?php else: ?>
                            <form action="/event?event_id=<?= $event_id ?>" method="GET" style="margin: 0;">
                                <input type="hidden" name="event_id" value="<?= $event_id ?>">
                                <input type="hidden" name="action" value="pay">
                                <button type="submit" class="primary-button register-btn" style="border: none;">Book at <?= $event['ticket_price'] ?></button>
                            </form>
                        <?php endif; ?>
                    <?php endif; ?>

                    <?php if ($is_event_organizer): ?>
                        <a href="javascript:void(0);" class="primary-button" style="background-color: #007BFF;" onclick="openModal()">Update</a>
                        <div id="editEventModal" class="modal">
                            <div class="modal-content">
                                <span class="close" onclick="closeModal()">&times;</span>
                                <h2>Edit Event Details</h2>
                                <form id="editEventForm" action="/event?event_id=<?= $event_id ?>" method="POST" enctype="multipart/form-data">
                                    <input type="hidden" name="edit" value="<?= $event_id ?>">
                                    <input type="hidden" name="action" value="edit">

                                    <label for="title">Event Title:</label>
                                    <input type="text" id="title" name="title" value="<?= htmlspecialchars($event['title']) ?>" required><br><br>

                                    <label for="location">Location:</label>
                                    <input type="text" id="location" name="location" value="<?= htmlspecialchars($event['location']) ?>" required><br><br>

                                    <label for="description">Description:</label>
                                    <textarea id="description" name="description"><?= htmlspecialchars($event['description']) ?></textarea><br><br>

                                    <label for="capacity">Capacity:</label>
                                    <input type="number" id="capacity" name="capacity" value="<?= htmlspecialchars($event['capacity']) ?>" required><br><br>

                                    <label for="ticket_price">Ticket Price:</label>
                                    <input type="number" id="ticket_price" name="ticket_price" value="<?= htmlspecialchars($event['ticket_price']) ?>" step="0.01" required><br><br>

                                    <button type="submit" style="border: none;" class="primary-button">Save Changes</button>
                                </form>
                            </div>
                        </div>

                        <form action="/event?event_id=<?= $event_id ?>" method="GET" style="margin: 0;">
                            <input type="hidden" name="event_id" value="<?= $event_id ?>">
                            <input type="hidden" name="action" value="delete">
                            <button type="submit" class="secondary-button" style="background-color: #E81C30; border:none; color: #fff;">Delete</button>
                        </form>
                    <?php endif; ?>
                </div>

                <div class="event-description">
                    <h2>Description</h2>
                    <p><?= nl2br(htmlspecialchars($event['description'] ?? 'No description available.')) ?></p>
                </div>
            </div>
        <?php endif; ?>
    </main>

    <?php include __DIR__ . '/../components/footer.php'; ?>
    <script src="../assets/js/event-modal.js"></script>
    </body>
</html>
